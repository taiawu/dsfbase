---
title: "R Notebook"
output: html_notebook
---
Looks like UMAP is the current best analysis for the curve shapes.

In this notebook, create a reproducible UMAP analysis
Test variations in hyperparameters
Test both raw, first, and second derivative data

```{r}

library(tidyverse)
library(umap)
library(glue)
library(embed) # required installation of python package "tensorflow", and therefore also reticulate
library(extrafont) # for cairo_pds 
# cairo_pdf (which will throw obscure error also if the save path to ggsave doens't exist -- see https://github.com/tidyverse/ggplot2/issues/4168)

# has unnecessarily complex directory creation system, but works... 
source("R/functions/umap.R") # helper functions to implement and plot UMAP using tidymodels
```

Read in dsfbase, and add derivatives
```{r}
dsfbase_deriv <- read_rds("/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/03_final_dsfbase/dsfbase_annotated.rds") |> 
  group_by(id) |> 
  arrange(Temperature) |> 
  mutate(drfu = signal::sgolayfilt(x = value_norm,
                                   m = 1),
         ddrfu = signal::sgolayfilt(x = value_norm,
                                   m = 2)) |> 
  ungroup()
```

Prepare dsfbase for umap, including derivatives
```{r}
rfu <- prep_for_UMAP(dsfbase_deriv, "value_norm")
drfu <- prep_for_UMAP(dsfbase_deriv, "drfu")
ddrfu <- prep_for_UMAP(dsfbase_deriv, "ddrfu")

rfu$id |> n_distinct() # [1] 4399
```
Test UMAP parameters for raw data
```{r}
# set parameters to explore
.test_neighbors <- c(10, 50, 100, 200, 400, 800)
.test_min_dists <- c(0.05, 0.1, 0.2, 0.4, 0.8)
UMAP_pars <- expand.grid(.test_neighbors, .test_min_dists) |> 
  set_names(c("n_neighbors", "min_dists"))

# directories to save results
.explore_pars <- "/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/parameter_exploration/"
.save_rfu <- glue::glue("{.explore_pars}rfu/")
.save_drfu <- glue::glue("{.explore_pars}drfu/")
.save_ddrfu <- glue::glue("{.explore_pars}ddrfu/")
fs::dir_create(c(.save_rfu, .save_drfu, .save_ddrfu))

explore_UMAP_pars(rfu, 
                  .n_neighbors = UMAP_pars$n_neighbors,
                  .min_dists = UMAP_pars$min_dists,
                  .other_notes = "Data: normalized RFU. \nNsp3 mac1 screen excluded from analysis.",
                  .save_to = .save_rfu,
                  .save_input = TRUE)

explore_UMAP_pars(drfu, 
                  .n_neighbors = UMAP_pars$n_neighbors,
                  .min_dists = UMAP_pars$min_dists,
                  .other_notes = "Data: first derivative of normalized RFU. \nNsp3 mac1 screen excluded from analysis.",
                  .save_to = .save_drfu,
                  .save_input = TRUE)

explore_UMAP_pars(ddrfu, 
                  .n_neighbors = UMAP_pars$n_neighbors,
                  .min_dists = UMAP_pars$min_dists,
                  .other_notes = "Data: second derivative of normalized RFU. \nNsp3 mac1 screen excluded from analysis.",
                  .save_to = .save_ddrfu,
                  .save_input = TRUE)
```

Conclusion: the final results are relatively insensitive to the parameters, and also the form on the input data (RFU, dRFU, and ddRFU). That's a good sign that the separation we are seeing is not an artifact of the specific processing or hyper-parameters of UMAP. Going to use the raw RFU clustering, since that is one less processing step. 

The "clearest" visualization, in my opinion, is the RFU data with 200 neighbors and min_dist = 0.2
```{r}
umap_100 <- read_rds("/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/parameter_exploration/rfu/results/dsfbase_umap_juice_neighbors_100_mindist_0.2.rds")
```

Make the main panel plot
```{r}
source("R/functions/umap.R") # helper functions to implement and plot UMAP using tidymodels

dsfbase_colors <- c("canon" = "#7A0404",
                    "noncanon" = "#E6450C",
                    "speculative" = "#FABA39",
                    "errata" = "grey")

p_umap <- plot_UMAP(UMAP_data = umap_100,
          .n_neighbors = 100, # just for making labels
          .min_dist = 0.2, # just for making labels
          .facet = FALSE, # don't facet in the main panel
          .other_notes = "Nsp3 mac1 screen excluded from analysis.", # keep in title for reminder. Crop in the final figure.
          .save_to = "/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/final_parameters/plots/main_text/",
          .save_name = "dsfbase_umap_",
          .return_plot = TRUE,
          .dsfbase_colors = dsfbase_colors)


p_umap_final <- p_umap +
  # change legend order
  scale_color_manual(values = dsfbase_colors, 
                     breaks = c("canon", "noncanon", "speculative", "errata")) +
  labs(subtitle = str_wrap("Parameters: 100 neighbors, 0.2 min distance. Nsp3 mac1 screen excluded from analysis."),
       color = "Subset") +
  
    # adjust theme
    hrbrthemes::theme_ipsum(base_size = 16,
                            axis_title_size = 14,
                            strip_text_size = 12) +
    theme(aspect.ratio = 1) 

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/final_parameters/plots/main_text/dsfbase_umap_100_min_dist_0.2.pdf",
       width = 6.3, # facet plots get saved larger
         height = 6.3, # facet plots get saved larger
         device = cairo_pdf)
```

Make facet plot by protein
```{r}
plot_UMAP_by_protein(umap_100, 100, 0.2, .save_to = "/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/final_parameters/plots/")
```

Are we losing important information to overplotting?
Make a density plot of the UMAP results
```{r}
umap_density <- umap_100 |> 
  ggplot(aes(x = UMAP1, y = UMAP2)) +
  
  geom_density_2d_filled(data = select(umap_100, -subset),
                         alpha = 0.5) +
  geom_density_2d(data = select(umap_100, -subset),
                  linewidth = 0.25, colour = "black") +
  
  # geom_density_2d_filled(alpha = 0.5) +
  # geom_density_2d(linewidth = 0.25, colour = "black") +
  
  geom_point(size = 0.05, alpha = 0.8)+
  facet_wrap(~subset, ncol = 2) +
  hrbrthemes::theme_ipsum() +
  theme(aspect.ratio = 1)

ggsave(filename = "/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/final_parameters/plots/density/UMAP_100_neighbors_0p2_mindist_density.pdf",
       width = 10,
        height = 15,
       device = cairo_pdf)
```

```{r}
umap_density2 <- umap_100 |> 
  ggplot(aes(x = UMAP1, y = UMAP2)) +
  # 
  # geom_density_2d_filled(data = select(umap_100, -subset),
  #                        alpha = 0.5) +
  # geom_density_2d(data = select(umap_100, -subset),
  #                 linewidth = 0.25, colour = "black") +
  
  geom_density_2d_filled(alpha = 0.5, contour_var = "count") +
  geom_density_2d(linewidth = 0.25, colour = "black",  contour_var = "count") +
  
  geom_point(size = 0.05, alpha = 0.8)+
  facet_wrap(~subset, ncol = 2) +
  hrbrthemes::theme_ipsum() +
  theme(aspect.ratio = 1)


ggsave(filename = "/Users/taiaseanwu/Desktop/programming/dsfbase/20231205_version/04_UMAP_analysis/final_parameters/plots/density/UMAP_100_neighbors_0p2_mindist_density_facet.pdf",
       width = 10,
        height = 15,
       device = cairo_pdf)

```
