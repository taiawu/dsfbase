---
title: "R Notebook"
output: html_notebook
---

Exploring options for clustering of DSFbase. 
Ideally, would love some visualization/simplification to address questions about curve shape
e.g.: 
- how truly "different" are canon and non-canon (also maybe help me edit classifications)
- are SYPRO and Aurora dye datasets different?

```{r}
library(tidyverse)
library(umap)
```

Approach 1: UMAP package in R (not using tidymodels)
Clustered easily enough--but need to investigate parameter tuning.
Tidymodels may offer a better approach. Try that. 
```{r}
dsfbase <- read_rds("/Users/taiaseanwu/Desktop/programming/dsfbase/03_combined_data/dsfbase.rds")

# transpose 
dsfbase_wide <- dsfbase |> 
  select(Temperature, value_norm, id) |> 
  pivot_wider(names_from = Temperature, values_from = value_norm)

# separate labels and data
dsfbase_data <- dsfbase_wide |>  select(-id)
dsfbase_label <- dsfbase_wide |> select(id)


# apply umap to data
dsfbase_umap <- umap(dsfbase_data)


dsfbase_layout <- dsfbase_umap[["layout"]] |> 
  as_tibble() |> 
  set_names("umap_x", "umap_y") |> 
  mutate(id = dsfbase_label$id) |> 
  left_join( dsfbase |> select(id, subset), by = join_by(id))
```

Plot UMAP results
```{r}
# plot umap results
p_umap <- dsfbase_layout  |> 
  ggplot(aes(x = umap_x, y = umap_y,
             color = subset)) +
  # scale_color_manual(values = c("SYPRO_canon" = "",
  #                               "canon" = "",
  #                               "SYPRO_noncanon" = "",
  #                               "noncanon" = "",
  #                               "gotcha" = "")) +
  scale_color_viridis_d(begin = 0, end = 0.9, option = "turbo") +
  geom_point(alpha = 0.5, size = 0.05) +
  hrbrthemes::theme_ipsum() +
  theme(aspect.ratio = 1) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  labs(title = "UMAP with default parameters, normalized RFUs", 
       x = "X", y = "Y", color = "Subset")

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/draft_plots/draft_umap.pdf",
       device = cairo_pdf)
```

Approach 2: various models using tidymodels framework
following along with https://juliasilge.com/blog/cocktail-recipes-umap/#umap
```{r}
library(tidymodels)

# transpose dsfbase data while retaining labeling columns
dsfbase_labeled <- 
  dsfbase |> 
  select(all_of(c("id", "protein", "subset", "Temperature", "value_norm"))) |> 
  pivot_wider(id_cols = c("id", "protein", "subset"),
              names_from = "Temperature",
              values_from = "value_norm")
```

PCA with tidymodels.
Thought: looks potentially too heavily driven by Tma?
```{r}
pca_rec <- recipe(~., data = dsfbase_labeled)  |> 
  update_role(id, protein, subset, new_role = "id") |> # set these cols as identifiers
  step_normalize(all_predictors()) |> 
  step_pca(all_predictors())

pca_prep <- prep(pca_rec)

# tidy and visualize the pca results
tidied_pca <- tidy(pca_prep, 2)

p_pca <- tidied_pca %>%
  filter(component %in% paste0("PC", 1:5)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(value, terms, fill = terms)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~component, nrow = 1) +
  labs(y = NULL,
       title = "DSFbase -- PCA of value_norm with tidymodels.",
       subtitle = str_wrap("Looks like Tma is driving the differences here, which is not what we want. Is that accurate?", 50)) +
  hrbrthemes::theme_ipsum()
  

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/draft_plots/draft_pca.pdf",
       width = 10,
       height = 15,
       device = cairo_pdf)

## this result looks so sensitive to Tma, which is not what we want

dsfbase_labeled$protein |> table()
```

UMAP with tidymodels
Because PCA looked really heavily driven by Tma,
is UMAP less sensitive / more sensitive to curve shapes?
```{r}
library(embed) # requird installation of python package "tensorflow"

umap_rec <- recipe(~., data = dsfbase_labeled |> filter(protein!="SP150_Nsp3")) %>%
  update_role(id, protein, subset, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_umap(all_predictors(),
             neighbors = 100,
             num_comp = 2,
             min_dist = 0.3)

umap_prep <- prep(umap_rec) # ~10 secs for 

write_rds()

UMAP_overlap <- juice(umap_prep) |> filter(subset != "gotcha")
UMAP_facet(UMAP_overlap, .n_neighbors = "10", .min_dist = "0p2")

```

Test UMAP parameters
```{r}
umap_data <- dsfbase_labeled |> filter(protein!="SP150_Nsp3")

test_UMAP <- function(umap_data,
                      .neighbors,
                      .min_dist,
                      .save_to = "/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/UMAPs/",
                      .save_name = "draft_umap_n_neighbors_"){
  umap_rec <- recipe(~., data = umap_data) %>%
  update_role(id, protein, subset, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_umap(all_predictors(),
             neighbors = .neighbors,
             num_comp = 2,
             min_dist = .min_dist)

umap_prep <- prep(umap_rec) # ~10 secs for 

UMAP_overlap <- juice(umap_prep) |> filter(subset != "gotcha")

save_to <- glue("{.save_to}{.save_name}_{.neighbors}_min_dist_{.min_dist}.rds")

write_rds(x = umap_prep,
         save_to)

UMAP_facet(UMAP_overlap, .n_neighbors = as.character(.neighbors), 
           .min_dist = as.character(.min_dist))
}
```

Test UMAP parameters
```{r}
iterate_UMAPs <- function(umap_data, 
                          .test_neighbors,
                          .test_min_dist,
                          .save_to,
                          ...) {
  
  map2(.x = .test_neighbors, .y = .test_min_dist,
       test_UMAP,
       umap_data,
       )
  
}

```


Iterate through UMAP parameters
#https://pair-code.github.io/understanding-umap/
```{r}
test_UMAP(umap_data, .neighbors = 500, .min_dist = 0.2)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.2)
test_UMAP(umap_data, .neighbors = 50, .min_dist = 0.2)
test_UMAP(umap_data, .neighbors = 10, .min_dist = 0.2)

test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.001)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.01)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.05)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.1)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.2)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.3)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.4)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.5)
test_UMAP(umap_data, .neighbors = 100, .min_dist = 0.6)

test_UMAP(umap_data, .neighbors = 50, .min_dist = 0.001)
test_UMAP(umap_data, .neighbors = 50, .min_dist = 0.01)
test_UMAP(umap_data, .neighbors = 50, .min_dist = 0.1)
test_UMAP(umap_data, .neighbors = 50, .min_dist = 0.2)
test_UMAP(umap_data, .neighbors = 50, .min_dist = 0.4)
```

### scratchwork below this line
Pick a few representative datasets from each subset
```{r}
umap_best <- read_rds("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/UMAPs/rds/draft_umap_n_neighbors_100_min_dist_0.3.rds") |> 
  juice()

UMAP_facet(umap_best |> filter(subset != "gotcha"), .n_neighbors = 100, .min_dist = 0.3)
UMAP_facet()
umap_best

# something in SYPRO canon from around c(0,0), c(0,6), c(-5, 6), c(-4, 0.5)
# something from canon from around c(4,6), c(11,0), c(-7, -2), c(-6, 1), c(6, -5)

# something from SYPRO noncanon from around c()
# something from noncanon around c(-1, 2), c(5, -2), c(5, 1.5), c(-3, -6), c(-3, -5)

SYPRO_canon_umap <- umap_best |> filter(subset == "SYPRO_canon") |> arrange(UMAP1, UMAP2)

SO_canon_label <- c("DSFbase001_SYPRO_canon_ID000675", "DSFbase001_SYPRO_canon_ID000391", "DSFbase001_SYPRO_canon_ID000079", "DSFbase001_SYPRO_canon_ID000109")

canon_umap <- umap_best |> filter(subset == "canon") |> arrange(desc(UMAP1))

canon_label <- c("DSFbase001_canon_ID001517", "DSFbase001_canon_ID001300", "DSFbase001_canon_ID004287", "DSFbase001_canon_ID002125", "DSFbase001_canon_ID004365","DSFbase001_canon_ID004800")
```


label umap
```{r}
dsfbase_colors <- c("SYPRO_canon" = "#FABA39",
                    "canon" = "#E6450C",
                    "SYPRO_noncanon" = "#1BE4B7",
                    "noncanon" = "#4686FA")

subset_shapes <- c("SYPRO_canon" = 16,
                    "canon" = 16,
                    "SYPRO_noncanon" = 16,
                    "noncanon" = 16)
# 
p_UMAP_labeled <- umap_best |> 
  ggplot(aes(UMAP1, UMAP2, label = id)) +
  geom_point(aes(color = subset), 
             alpha = 0.5, 
             size = 0.5,
             stroke = 0.1) +
   ggrepel::geom_text_repel(data = umap_best |> filter(id %in% c(canon_label, SO_canon_label)), 
                            box.padding = 0.5,
                            max.overlaps = Inf,
                            nudge_x = 10,
                            nudge_y = 5) +
  #geom_text(check_overlap = TRUE, hjust = "inward", family = "IBMPlexSans") +
  labs(color = NULL) +
  #scale_shape_manual(values = subset_shapes) +
  scale_color_manual(values = dsfbase_colors) +
  # scale_color_viridis_d(option = "turbo") +
   labs(y = NULL,
       title = "DSFbase -- UMAP of value_norm with tidymodels.",
       subtitle = str_wrap("n_neighbors set to 100, min_dist = 0.3 Gotcha subset not displayed. Nsp3 mac1 removed prior to calculation.", 50)) +
  hrbrthemes::theme_ipsum() +
  theme(aspect.ratio = 1) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) # don't make legend really transparent
  

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/draft_umap_labeled.pdf",
       width = 7,
       height = 7,
       device = cairo_pdf)

```




Visualize UMAP
```{r}
dsfbase_colors <- c("SYPRO_canon" = "#FABA39",
                    "canon" = "#E6450C",
                    "SYPRO_noncanon" = "#1BE4B7",
                    "noncanon" = "#4686FA")

subset_shapes <- c("SYPRO_canon" = 16,
                    "canon" = 16,
                    "SYPRO_noncanon" = 16,
                    "noncanon" = 16)
# 
p_UMAP <- juice(umap_prep) %>%
  filter(subset != "gotcha") |> 
  ggplot(aes(UMAP1, UMAP2)) +
  geom_point(aes(color = subset), 
             alpha = 0.5, 
             size = 0.5,
             stroke = 0.1) +
  #geom_text(check_overlap = TRUE, hjust = "inward", family = "IBMPlexSans") +
  labs(color = NULL) +
  #scale_shape_manual(values = subset_shapes) +
  scale_color_manual(values = dsfbase_colors) +
  # scale_color_viridis_d(option = "turbo") +
   labs(y = NULL,
       title = "DSFbase -- UMAP of value_norm with tidymodels.",
       subtitle = str_wrap("n_neighbors set to 100, min_dist = 0.3 Gotcha subset not displayed. Nsp3 mac1 removed prior to calculation.", 50)) +
  hrbrthemes::theme_ipsum() +
  theme(aspect.ratio = 1) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) # don't make legend really transparent
  

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/draft_plots/draft_umap_n_neighbors_100_min_dist_0p3_no_mac1.pdf",
       width = 7,
       height = 7,
       device = cairo_pdf)
```


Function to plot UMAP results - UMAP_facet()
```{r}
UMAP_facet <- function(UMAP_data,
                       .n_neighbors,
                       .min_dist,
                       .other_notes = "_no_mac1_facet",
                       .x = "UMAP1",
                       .y = "UMAP2",
                       .save_to = "/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/UMAPs/",
                       .save_name = "draft_umap_n_neighbors_",
                      ...){
  
  save_name <- glue("{.save_to}{.save_name}{.n_neighbors}_min_dist_{.min_dist}_{.other_notes}.pdf")


p_UMAP <- 
  UMAP_data |> 
   ggplot(aes(.data[[.x]], .data[[.y]])) +
  
  geom_point(data = select(UMAP_data, -subset),
             color = "grey", 
             size = 0.05, 
             alpha = 0.5) +
  
  geom_point(aes(color = subset), 
             alpha = 0.8, 
             size = 0.5) +
  
  labs(color = NULL) +

  scale_color_manual(values = dsfbase_colors) +
  
  facet_wrap(~subset, scales= "free") +
   labs(y = NULL,
       title = glue("DSFbase -- UMAP of value_norm. \n {.n_neighbors} neighbors; {.min_dist} min dist."),
       subtitle = str_wrap(glue("n_neighbors set to {.n_neighbors}, min_dist = {.min_dist}. Gotcha subset not displayed. Notes: {.other_notes}"), 50)) +
  hrbrthemes::theme_ipsum(base_size = 20,
                          strip_text_size = 20) +
  theme(aspect.ratio = 1) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) # don't make legend really transparent
  
ggsave(save_name,
       width = 15,
       height = 15,
       device = cairo_pdf)
  
}
```


UMAP overlap
```{r}
UMAP_overlap <- juice(umap_prep) |>
  filter(subset != "gotcha")



p_UMAP <- 
  UMAP_overlap |> 
 
   ggplot(aes(UMAP1, UMAP2)) +
  
  geom_point(data = select(UMAP_overlap, -subset),
             color = "grey", 
             size = 0.05, 
             alpha = 0.5) +
  
  geom_point(aes(color = subset), 
             alpha = 0.8, 
             size = 0.5) +
  
  labs(color = NULL) +

  scale_color_manual(values = dsfbase_colors) +
  
  facet_wrap(~subset) +
   labs(y = NULL,
       title = "DSFbase -- UMAP of value_norm with tidymodels.",
       subtitle = str_wrap("n_neighbors set to 100, min_dist = 0.3 Gotcha subset not displayed. Nsp3 mac1 removed prior to calculation.", 50)) +
  hrbrthemes::theme_ipsum(base_size = 20,
                          strip_text_size = 20) +
  theme(aspect.ratio = 1) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) # don't make legend really transparent
  

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/draft_plots/draft_umap_n_neighbors_100_min_dist_0p3_no_mac1_facet.pdf",
       width = 15,
       height = 15,
       device = cairo_pdf)

```


UMAP plot, colored by protein
```{r}
p_UMAP_protein <- juice(umap_prep) %>%
  filter(subset != "gotcha") |> 
  ggplot(aes(UMAP1, UMAP2)) +
  geom_point(aes(color = protein), 
             alpha = 0.2, 
             size = .5,
             stroke = 0.1) +
  #geom_text(check_overlap = TRUE, hjust = "inward", family = "IBMPlexSans") +
  labs(color = NULL) +
  # scale_shape_manual(values = subset_shapes) +
  # scale_color_manual(values = dsfbase_colors) +
  scale_color_viridis_d(option = "turbo") +
   labs(title = "DSFbase -- UMAP of value_norm with tidymodels.",
       subtitle = str_wrap("Default paramters. Gotcha subset removed.", 50)) +
  hrbrthemes::theme_ipsum() +
  theme(aspect.ratio = 1,
        legend.position = "none") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) # don't make legend really transparent
  

ggsave("/Users/taiaseanwu/Desktop/programming/dsfbase/04_plots/draft_plots/draft_umap_colored_by_protein.pdf",
       width = 7,
       height = 7,
       device = cairo_pdf)
```



Load reticulate
Install python packages using `py_install()`
```{r}
library(reticulate)
# install.packages("umap")
# py_install("pandas")
# py_install("scikit-learn")
# py_install("umap-learn")
# py_install("tensorflow") # needed for R library embed
```

```{python}
import pandas as pd
import numpy as np
import sklearn
import umap
```

```{r}
# following advice from stack overflow on a similar issue...
# https://stackoverflow.com/questions/76926118/setup-reticulate-virtual-environment-with-python-3-11-4
# reticulate::install_python("3.11:latest") # 
```

Read in the full, normalized dsfbase file
```{python}
dsfbase = pd.read_csv("/Users/taiaseanwu/Desktop/programming/dsfbase/03_combined_data/by_subset/dsfbase_all_6722_curves.csv")
```

Transpose and apply tsne
```{r}

```



